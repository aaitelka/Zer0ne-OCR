name: Build Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

env:
  VERSION: "1.0.0-alpha"

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Make gradlew executable
        run: chmod +x ./gradlew
        shell: bash

      - name: Build MSI
        run: ./gradlew :composeApp:packageMsi --no-daemon --stacktrace

      - name: Rename MSI with version
        run: |
          $msiFile = Get-ChildItem -Path "composeApp/build/compose/binaries/main/msi/*.msi" | Select-Object -First 1
          $newName = "Zer0ne-OCR-${{ env.VERSION }}.msi"
          Rename-Item -Path $msiFile.FullName -NewName $newName
          Write-Host "Renamed to: $newName"
          Write-Host "File size: $([math]::Round((Get-Item "composeApp/build/compose/binaries/main/msi/$newName").Length / 1MB, 2)) MB"
        shell: pwsh

      - name: Test MSI Installation
        run: |
          $msiFile = Get-ChildItem -Path "composeApp/build/compose/binaries/main/msi/*.msi" | Select-Object -First 1
          Write-Host "=== Testing MSI: $($msiFile.FullName) ==="
          Write-Host "File size: $([math]::Round($msiFile.Length / 1MB, 2)) MB"
          
          # Install MSI silently
          Write-Host "`n=== Installing MSI... ==="
          $process = Start-Process msiexec.exe -ArgumentList "/i", "`"$($msiFile.FullName)`"", "/qn", "/norestart", "/l*v", "install.log" -Wait -PassThru -NoNewWindow
          Write-Host "Installation exit code: $($process.ExitCode)"
          
          # Show install log if failed
          if ($process.ExitCode -ne 0) {
            Write-Host "=== Installation Log (last 50 lines) ==="
            Get-Content install.log -Tail 50
          }
          
          # Find installation directory
          Write-Host "`n=== Searching for installed application... ==="
          $installPaths = @(
            "$env:ProgramFiles\Zer0ne-OCR",
            "$env:LOCALAPPDATA\Zer0ne-OCR",
            "$env:LOCALAPPDATA\Programs\Zer0ne-OCR"
          )
          
          $foundPath = $null
          foreach ($path in $installPaths) {
            if (Test-Path $path) {
              Write-Host "Found installation at: $path"
              $foundPath = $path
              break
            }
          }
          
          if ($foundPath) {
            Write-Host "`n=== Installation contents ==="
            Get-ChildItem -Recurse $foundPath | Select-Object FullName, Length | Format-Table -AutoSize
            
            # Try to find and run the exe
            $exeFile = Get-ChildItem -Path $foundPath -Filter "*.exe" -Recurse | Select-Object -First 1
            if ($exeFile) {
              Write-Host "`n=== Found executable: $($exeFile.FullName) ==="
              Write-Host "Attempting to start application (will timeout after 10s)..."
              
              # Start the app and let it run briefly
              $appProcess = Start-Process -FilePath $exeFile.FullName -PassThru
              Start-Sleep -Seconds 10
              
              if (!$appProcess.HasExited) {
                Write-Host "Application is running! (PID: $($appProcess.Id))"
                Write-Host "Stopping application..."
                Stop-Process -Id $appProcess.Id -Force
                Write-Host "SUCCESS: Application started and ran correctly!"
              } else {
                Write-Host "Application exited with code: $($appProcess.ExitCode)"
              }
            }
          } else {
            Write-Host "WARNING: Could not find installation directory"
          }
          
          # Uninstall
          Write-Host "`n=== Uninstalling... ==="
          Start-Process msiexec.exe -ArgumentList "/x", "`"$($msiFile.FullName)`"", "/qn", "/norestart" -Wait -NoNewWindow
          Write-Host "Uninstallation complete"
        shell: pwsh
        continue-on-error: true

      - name: Upload MSI
        uses: actions/upload-artifact@v4
        with:
          name: windows-msi
          path: composeApp/build/compose/binaries/main/msi/*.msi

  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Build DMG
        run: ./gradlew :composeApp:packageDmg --no-daemon --stacktrace

      - name: Rename DMG with version
        run: |
          dmgFile=$(find composeApp/build/compose/binaries/main/dmg -name "*.dmg" | head -1)
          newName="Zer0ne-OCR-${{ env.VERSION }}.dmg"
          mv "$dmgFile" "composeApp/build/compose/binaries/main/dmg/${newName}"
          echo "Renamed to: ${newName}"
          ls -lh composeApp/build/compose/binaries/main/dmg/

      - name: Upload DMG
        uses: actions/upload-artifact@v4
        with:
          name: macos-dmg
          path: composeApp/build/compose/binaries/main/dmg/*.dmg

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Install required packages
        run: sudo apt-get update && sudo apt-get install -y fakeroot

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Build DEB
        run: ./gradlew :composeApp:packageDeb --no-daemon --stacktrace

      - name: Rename DEB with version
        run: |
          debFile=$(find composeApp/build/compose/binaries/main/deb -name "*.deb" | head -1)
          newName="zer0ne-ocr_${{ env.VERSION }}_amd64.deb"
          mv "$debFile" "composeApp/build/compose/binaries/main/deb/${newName}"
          echo "Renamed to: ${newName}"
          ls -lh composeApp/build/compose/binaries/main/deb/

      - name: Upload DEB
        uses: actions/upload-artifact@v4
        with:
          name: linux-deb
          path: composeApp/build/compose/binaries/main/deb/*.deb

  release:
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: |
          echo "=== All artifacts ==="
          find artifacts -type f -exec ls -lh {} \;

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/windows-msi/*.msi
            artifacts/macos-dmg/*.dmg
            artifacts/linux-deb/*.deb
          body: |
            ## üöÄ First Alpha Release - v${{ env.VERSION }}

            ### Features
            - üñºÔ∏è **Invoice OCR** - Extract invoice data from images (PNG, JPG, JPEG) and PDFs using Groq AI (Llama 4 Maverick model)
            - üìä **Excel Export** - Automatically export extracted data to Excel files
            - üîÑ **PDF Tools** - Convert PDFs to images and vice versa
            - üìÅ **Batch Processing** - Process multiple files at once
            - üé® **Modern UI** - JetBrains Toolbox-inspired design with dark/light theme support
            - üîë **API Key Rotation** - Automatically rotate through multiple Groq API keys to avoid rate limits
            - üìú **History** - View previously exported Excel files
            - üìç **Flexible API Keys Location** - Supports multiple standard locations for api_keys.txt

            ### API Keys File Locations
            The application searches for `api_keys.txt` in these locations (in order):
            - **Windows**: `%USERPROFILE%\.zer0ne-ocr\`, AppData, installation dir
            - **Linux/macOS**: `~/.zer0ne-ocr/`, current dir, installation dir

            ### Installation
            - **Windows**: Download and run `Zer0ne-OCR-${{ env.VERSION }}.msi`
            - **macOS**: Download and mount `Zer0ne-OCR-${{ env.VERSION }}.dmg`
            - **Linux**: Download and install `zer0ne-ocr_${{ env.VERSION }}_amd64.deb`

            ### Requirements
            - [Groq API Key(s)](https://console.groq.com/keys)
