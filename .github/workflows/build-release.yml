name: Build Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

env:
  VERSION: ${{ github.ref_name }}

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Make gradlew executable
        run: chmod +x ./gradlew
        shell: bash

      - name: Build Release MSI
        run: ./gradlew :composeApp:packageReleaseMsi --no-daemon --stacktrace

      - name: List build output
        run: |
          Get-ChildItem -Recurse composeApp/build/compose/binaries/
        shell: pwsh

      - name: Rename MSI with version
        run: |
          $version = "${{ github.ref_name }}".TrimStart('v')
          $msiFile = Get-ChildItem -Path "composeApp/build/compose/binaries/main-release/msi/*.msi" | Select-Object -First 1
          $newName = "Zer0ne-OCR-$version.msi"
          Rename-Item -Path $msiFile.FullName -NewName $newName
          Write-Host "Renamed to: $newName"
        shell: pwsh

      - name: Test MSI Installation
        run: |
          $msiFile = Get-ChildItem -Path "composeApp/build/compose/binaries/main-release/msi/*.msi" | Select-Object -First 1
          Write-Host "Testing MSI: $($msiFile.FullName)"
          Write-Host "File size: $([math]::Round($msiFile.Length / 1MB, 2)) MB"
          # Validate MSI
          Start-Process msiexec.exe -ArgumentList "/i", "`"$($msiFile.FullName)`"", "/qn", "/norestart", "TARGETDIR=C:\TestInstall" -Wait -NoNewWindow
          if (Test-Path "C:\TestInstall") {
            Write-Host "Installation directory created successfully"
            Get-ChildItem -Recurse "C:\TestInstall" | Select-Object FullName
          }
        shell: pwsh
        continue-on-error: true

      - name: Upload MSI
        uses: actions/upload-artifact@v4
        with:
          name: windows-msi
          path: composeApp/build/compose/binaries/main-release/msi/*.msi

  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Build Release DMG
        run: ./gradlew :composeApp:packageReleaseDmg --no-daemon --stacktrace

      - name: Rename DMG with version
        run: |
          version="${{ github.ref_name }}"
          version="${version#v}"
          dmgFile=$(find composeApp/build/compose/binaries/main-release/dmg -name "*.dmg" | head -1)
          newName="Zer0ne-OCR-${version}.dmg"
          mv "$dmgFile" "composeApp/build/compose/binaries/main-release/dmg/${newName}"
          echo "Renamed to: ${newName}"
          ls -lh composeApp/build/compose/binaries/main-release/dmg/

      - name: Upload DMG
        uses: actions/upload-artifact@v4
        with:
          name: macos-dmg
          path: composeApp/build/compose/binaries/main-release/dmg/*.dmg

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Install required packages
        run: sudo apt-get update && sudo apt-get install -y fakeroot

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Build Release DEB
        run: ./gradlew :composeApp:packageReleaseDeb --no-daemon --stacktrace

      - name: Rename DEB with version
        run: |
          version="${{ github.ref_name }}"
          version="${version#v}"
          debFile=$(find composeApp/build/compose/binaries/main-release/deb -name "*.deb" | head -1)
          newName="zer0ne-ocr_${version}_amd64.deb"
          mv "$debFile" "composeApp/build/compose/binaries/main-release/deb/${newName}"
          echo "Renamed to: ${newName}"
          ls -lh composeApp/build/compose/binaries/main-release/deb/

      - name: Upload DEB
        uses: actions/upload-artifact@v4
        with:
          name: linux-deb
          path: composeApp/build/compose/binaries/main-release/deb/*.deb

  release:
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: |
          echo "=== All artifacts ==="
          find artifacts -type f -exec ls -lh {} \;

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/windows-msi/*.msi
            artifacts/macos-dmg/*.dmg
            artifacts/linux-deb/*.deb
          generate_release_notes: true
